<!DOCTYPE html>
<html >

<head>

  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>Deep Learning from Scratch in R</title>
  <meta name="description" content="Deep Learning from Scratch in R">
  <meta name="generator" content="bookdown 0.4 and GitBook 2.6.7">

  <meta property="og:title" content="Deep Learning from Scratch in R" />
  <meta property="og:type" content="book" />
  
  
  
  

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Deep Learning from Scratch in R" />
  
  
  

<meta name="author" content="Kota Mori">



  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  
  
<link rel="prev" href="perceptron.html">
<link rel="next" href="training-neural-network.html">
<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />









<style type="text/css">
div.sourceCode { overflow-x: auto; }
table.sourceCode, tr.sourceCode, td.lineNumbers, td.sourceCode {
  margin: 0; padding: 0; vertical-align: baseline; border: none; }
table.sourceCode { width: 100%; line-height: 100%; }
td.lineNumbers { text-align: right; padding-right: 4px; padding-left: 4px; color: #aaaaaa; border-right: 1px solid #aaaaaa; }
td.sourceCode { padding-left: 5px; }
code > span.kw { color: #007020; font-weight: bold; } /* Keyword */
code > span.dt { color: #902000; } /* DataType */
code > span.dv { color: #40a070; } /* DecVal */
code > span.bn { color: #40a070; } /* BaseN */
code > span.fl { color: #40a070; } /* Float */
code > span.ch { color: #4070a0; } /* Char */
code > span.st { color: #4070a0; } /* String */
code > span.co { color: #60a0b0; font-style: italic; } /* Comment */
code > span.ot { color: #007020; } /* Other */
code > span.al { color: #ff0000; font-weight: bold; } /* Alert */
code > span.fu { color: #06287e; } /* Function */
code > span.er { color: #ff0000; font-weight: bold; } /* Error */
code > span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
code > span.cn { color: #880000; } /* Constant */
code > span.sc { color: #4070a0; } /* SpecialChar */
code > span.vs { color: #4070a0; } /* VerbatimString */
code > span.ss { color: #bb6688; } /* SpecialString */
code > span.im { } /* Import */
code > span.va { color: #19177c; } /* Variable */
code > span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code > span.op { color: #666666; } /* Operator */
code > span.bu { } /* BuiltIn */
code > span.ex { } /* Extension */
code > span.pp { color: #bc7a00; } /* Preprocessor */
code > span.at { color: #7d9029; } /* Attribute */
code > span.do { color: #ba2121; font-style: italic; } /* Documentation */
code > span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code > span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code > span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
</style>

</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>Preface</a></li>
<li class="chapter" data-level="1" data-path="introduction-to-r-and-some-remarks-on-differences-from-python.html"><a href="introduction-to-r-and-some-remarks-on-differences-from-python.html"><i class="fa fa-check"></i><b>1</b> Introduction to R, and some remarks on differences from Python</a><ul>
<li class="chapter" data-level="1.1" data-path="introduction-to-r-and-some-remarks-on-differences-from-python.html"><a href="introduction-to-r-and-some-remarks-on-differences-from-python.html#data-types"><i class="fa fa-check"></i><b>1.1</b> Data types</a></li>
<li class="chapter" data-level="1.2" data-path="introduction-to-r-and-some-remarks-on-differences-from-python.html"><a href="introduction-to-r-and-some-remarks-on-differences-from-python.html#variables"><i class="fa fa-check"></i><b>1.2</b> Variables</a></li>
<li class="chapter" data-level="1.3" data-path="introduction-to-r-and-some-remarks-on-differences-from-python.html"><a href="introduction-to-r-and-some-remarks-on-differences-from-python.html#list-and-vectors"><i class="fa fa-check"></i><b>1.3</b> List and vectors</a></li>
<li class="chapter" data-level="1.4" data-path="introduction-to-r-and-some-remarks-on-differences-from-python.html"><a href="introduction-to-r-and-some-remarks-on-differences-from-python.html#dictionary-and-hash-table"><i class="fa fa-check"></i><b>1.4</b> Dictionary, and hash table</a></li>
<li class="chapter" data-level="1.5" data-path="introduction-to-r-and-some-remarks-on-differences-from-python.html"><a href="introduction-to-r-and-some-remarks-on-differences-from-python.html#boolean-or-logicals"><i class="fa fa-check"></i><b>1.5</b> Boolean or logicals</a></li>
<li class="chapter" data-level="1.6" data-path="introduction-to-r-and-some-remarks-on-differences-from-python.html"><a href="introduction-to-r-and-some-remarks-on-differences-from-python.html#if-statement"><i class="fa fa-check"></i><b>1.6</b> If-statement</a></li>
<li class="chapter" data-level="1.7" data-path="introduction-to-r-and-some-remarks-on-differences-from-python.html"><a href="introduction-to-r-and-some-remarks-on-differences-from-python.html#for-loop"><i class="fa fa-check"></i><b>1.7</b> For loop</a></li>
<li class="chapter" data-level="1.8" data-path="introduction-to-r-and-some-remarks-on-differences-from-python.html"><a href="introduction-to-r-and-some-remarks-on-differences-from-python.html#functions"><i class="fa fa-check"></i><b>1.8</b> Functions</a></li>
<li class="chapter" data-level="1.9" data-path="introduction-to-r-and-some-remarks-on-differences-from-python.html"><a href="introduction-to-r-and-some-remarks-on-differences-from-python.html#script-file"><i class="fa fa-check"></i><b>1.9</b> Script File</a></li>
<li class="chapter" data-level="1.10" data-path="introduction-to-r-and-some-remarks-on-differences-from-python.html"><a href="introduction-to-r-and-some-remarks-on-differences-from-python.html#class"><i class="fa fa-check"></i><b>1.10</b> Class</a></li>
<li class="chapter" data-level="1.11" data-path="introduction-to-r-and-some-remarks-on-differences-from-python.html"><a href="introduction-to-r-and-some-remarks-on-differences-from-python.html#matrix-and-array"><i class="fa fa-check"></i><b>1.11</b> Matrix and array</a></li>
<li class="chapter" data-level="1.12" data-path="introduction-to-r-and-some-remarks-on-differences-from-python.html"><a href="introduction-to-r-and-some-remarks-on-differences-from-python.html#broadcast"><i class="fa fa-check"></i><b>1.12</b> Broadcast</a></li>
<li class="chapter" data-level="1.13" data-path="introduction-to-r-and-some-remarks-on-differences-from-python.html"><a href="introduction-to-r-and-some-remarks-on-differences-from-python.html#array"><i class="fa fa-check"></i><b>1.13</b> Array</a></li>
<li class="chapter" data-level="1.14" data-path="introduction-to-r-and-some-remarks-on-differences-from-python.html"><a href="introduction-to-r-and-some-remarks-on-differences-from-python.html#access-matrixarray-elements"><i class="fa fa-check"></i><b>1.14</b> Access matrix/array elements</a></li>
<li class="chapter" data-level="1.15" data-path="introduction-to-r-and-some-remarks-on-differences-from-python.html"><a href="introduction-to-r-and-some-remarks-on-differences-from-python.html#plot"><i class="fa fa-check"></i><b>1.15</b> Plot</a></li>
<li class="chapter" data-level="1.16" data-path="introduction-to-r-and-some-remarks-on-differences-from-python.html"><a href="introduction-to-r-and-some-remarks-on-differences-from-python.html#image-plot"><i class="fa fa-check"></i><b>1.16</b> Image plot</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="perceptron.html"><a href="perceptron.html"><i class="fa fa-check"></i><b>2</b> Perceptron</a></li>
<li class="chapter" data-level="3" data-path="neural-network.html"><a href="neural-network.html"><i class="fa fa-check"></i><b>3</b> Neural Network</a><ul>
<li class="chapter" data-level="3.1" data-path="neural-network.html"><a href="neural-network.html#activation-functions"><i class="fa fa-check"></i><b>3.1</b> Activation functions</a><ul>
<li class="chapter" data-level="3.1.1" data-path="neural-network.html"><a href="neural-network.html#step-function"><i class="fa fa-check"></i><b>3.1.1</b> Step function</a></li>
<li class="chapter" data-level="3.1.2" data-path="neural-network.html"><a href="neural-network.html#sigmoid-function"><i class="fa fa-check"></i><b>3.1.2</b> Sigmoid function</a></li>
<li class="chapter" data-level="3.1.3" data-path="neural-network.html"><a href="neural-network.html#rectified-linear-unit-relu"><i class="fa fa-check"></i><b>3.1.3</b> Rectified Linear Unit (ReLU)</a></li>
</ul></li>
<li class="chapter" data-level="3.2" data-path="neural-network.html"><a href="neural-network.html#array-manipulation"><i class="fa fa-check"></i><b>3.2</b> Array manipulation</a><ul>
<li class="chapter" data-level="3.2.1" data-path="neural-network.html"><a href="neural-network.html#dot-product"><i class="fa fa-check"></i><b>3.2.1</b> Dot product</a></li>
<li class="chapter" data-level="3.2.2" data-path="neural-network.html"><a href="neural-network.html#dot-products-in-neural-network"><i class="fa fa-check"></i><b>3.2.2</b> Dot products in neural network</a></li>
<li class="chapter" data-level="3.2.3" data-path="neural-network.html"><a href="neural-network.html#implementing-3-layer-neural-network"><i class="fa fa-check"></i><b>3.2.3</b> Implementing 3-layer neural network</a></li>
</ul></li>
<li class="chapter" data-level="3.3" data-path="neural-network.html"><a href="neural-network.html#output-layer"><i class="fa fa-check"></i><b>3.3</b> Output layer</a></li>
<li class="chapter" data-level="3.4" data-path="neural-network.html"><a href="neural-network.html#mnist"><i class="fa fa-check"></i><b>3.4</b> MNIST</a><ul>
<li class="chapter" data-level="3.4.1" data-path="neural-network.html"><a href="neural-network.html#convert-pickled-sample-weights-to-r-data"><i class="fa fa-check"></i><b>3.4.1</b> Convert pickled sample weights to R data</a></li>
<li class="chapter" data-level="3.4.2" data-path="neural-network.html"><a href="neural-network.html#prediction-with-sample-network-weights"><i class="fa fa-check"></i><b>3.4.2</b> Prediction with sample network weights</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="4" data-path="training-neural-network.html"><a href="training-neural-network.html"><i class="fa fa-check"></i><b>4</b> Training Neural Network</a><ul>
<li class="chapter" data-level="4.1" data-path="training-neural-network.html"><a href="training-neural-network.html#loss-functions"><i class="fa fa-check"></i><b>4.1</b> Loss functions</a></li>
<li class="chapter" data-level="4.2" data-path="training-neural-network.html"><a href="training-neural-network.html#numerical-differentiation"><i class="fa fa-check"></i><b>4.2</b> Numerical Differentiation</a></li>
<li class="chapter" data-level="4.3" data-path="training-neural-network.html"><a href="training-neural-network.html#gradient"><i class="fa fa-check"></i><b>4.3</b> Gradient</a></li>
<li class="chapter" data-level="4.4" data-path="training-neural-network.html"><a href="training-neural-network.html#gradient-descent"><i class="fa fa-check"></i><b>4.4</b> Gradient Descent</a></li>
</ul></li>
</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Deep Learning from Scratch in R</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="neural-network" class="section level1">
<h1><span class="header-section-number">3</span> Neural Network</h1>
<p>This chapter corresponds to Chapter 3, “Neural Network” in the <a href="https://github.com/oreilly-japan/deep-learning-from-scratch">original book</a>.</p>
<div id="activation-functions" class="section level2">
<h2><span class="header-section-number">3.1</span> Activation functions</h2>
<div id="step-function" class="section level3">
<h3><span class="header-section-number">3.1.1</span> Step function</h3>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(ggplot2)
step_func &lt;-<span class="st"> </span>function(a) { <span class="kw">as.integer</span>(a &gt;<span class="st"> </span><span class="dv">0</span>) }

x &lt;-<span class="st"> </span><span class="kw">seq</span>(-<span class="dv">5</span>, <span class="dv">5</span>, <span class="fl">0.1</span>)
y &lt;-<span class="st"> </span><span class="kw">step_func</span>(x)
<span class="kw">qplot</span>(x, y, <span class="dt">geom=</span><span class="st">&quot;line&quot;</span>)</code></pre></div>
<p><img src="_main_files/figure-html/unnamed-chunk-24-1.png" width="672" /></p>
</div>
<div id="sigmoid-function" class="section level3">
<h3><span class="header-section-number">3.1.2</span> Sigmoid function</h3>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">sigmoid &lt;-<span class="st"> </span>function(a) { <span class="dv">1</span> /<span class="st"> </span>(<span class="dv">1</span> +<span class="st"> </span><span class="kw">exp</span>(-a)) }

x &lt;-<span class="st"> </span><span class="kw">c</span>(-<span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">2</span>)
<span class="kw">sigmoid</span>(x)</code></pre></div>
<pre><code>## [1] 0.2689414 0.7310586 0.8807971</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">x &lt;-<span class="st"> </span><span class="kw">seq</span>(-<span class="dv">5</span>, <span class="dv">5</span>, <span class="fl">0.1</span>)
y &lt;-<span class="st"> </span><span class="kw">sigmoid</span>(x)
<span class="kw">qplot</span>(x, y, <span class="dt">geom=</span><span class="st">&quot;line&quot;</span>)</code></pre></div>
<p><img src="_main_files/figure-html/unnamed-chunk-25-1.png" width="672" /></p>
</div>
<div id="rectified-linear-unit-relu" class="section level3">
<h3><span class="header-section-number">3.1.3</span> Rectified Linear Unit (ReLU)</h3>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">relu &lt;-<span class="st"> </span>function(a) { <span class="kw">pmax</span>(<span class="dv">0</span>, a) }

x &lt;-<span class="st"> </span><span class="kw">seq</span>(-<span class="dv">5</span>, <span class="dv">5</span>, <span class="fl">0.1</span>)
y &lt;-<span class="st"> </span><span class="kw">relu</span>(x)
<span class="kw">qplot</span>(x, y, <span class="dt">geom=</span><span class="st">&quot;line&quot;</span>)</code></pre></div>
<p><img src="_main_files/figure-html/unnamed-chunk-26-1.png" width="672" /></p>
</div>
</div>
<div id="array-manipulation" class="section level2">
<h2><span class="header-section-number">3.2</span> Array manipulation</h2>
<p>Python’s <code>shape</code> corresponds to R’s <code>dim</code> function. There is no <code>ndim</code> counterpart in R; Use <code>length(dim(A))</code>. We use <code>array</code> instead of <code>c</code> to make a 1d-array. Doing so we can apply <code>dim</code> function.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">A &lt;-<span class="st"> </span><span class="kw">array</span>(<span class="dv">1</span>:<span class="dv">4</span>)
<span class="kw">length</span>(<span class="kw">dim</span>(A))</code></pre></div>
<pre><code>## [1] 1</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">dim</span>(A)</code></pre></div>
<pre><code>## [1] 4</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">B &lt;-<span class="st"> </span><span class="kw">matrix</span>(<span class="kw">c</span>(<span class="dv">1</span>:<span class="dv">6</span>), <span class="dt">nrow=</span><span class="dv">3</span>, <span class="dt">ncol=</span><span class="dv">2</span>, <span class="dt">byrow=</span><span class="ot">TRUE</span>)
B</code></pre></div>
<pre><code>##      [,1] [,2]
## [1,]    1    2
## [2,]    3    4
## [3,]    5    6</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">length</span>(<span class="kw">dim</span>(B))</code></pre></div>
<pre><code>## [1] 2</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">dim</span>(B)</code></pre></div>
<pre><code>## [1] 3 2</code></pre>
<div id="dot-product" class="section level3">
<h3><span class="header-section-number">3.2.1</span> Dot product</h3>
<p>Dot product is calculated by the <code>%*%</code> operator.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">A &lt;-<span class="st"> </span><span class="kw">matrix</span>(<span class="dv">1</span>:<span class="dv">4</span>, <span class="dt">nrow=</span><span class="dv">2</span>, <span class="dt">ncol=</span><span class="dv">2</span>, <span class="dt">byrow=</span><span class="ot">TRUE</span>)
<span class="kw">dim</span>(A)</code></pre></div>
<pre><code>## [1] 2 2</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">B &lt;-<span class="st"> </span><span class="kw">matrix</span>(<span class="dv">5</span>:<span class="dv">8</span>, <span class="dt">nrow=</span><span class="dv">2</span>, <span class="dt">ncol=</span><span class="dv">2</span>, <span class="dt">byrow=</span><span class="ot">TRUE</span>)
<span class="kw">dim</span>(B)</code></pre></div>
<pre><code>## [1] 2 2</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">A %*%<span class="st"> </span>B</code></pre></div>
<pre><code>##      [,1] [,2]
## [1,]   19   22
## [2,]   43   50</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">A &lt;-<span class="st"> </span><span class="kw">matrix</span>(<span class="dv">1</span>:<span class="dv">6</span>, <span class="dt">nrow=</span><span class="dv">2</span>, <span class="dt">ncol=</span><span class="dv">3</span>, <span class="dt">byrow=</span><span class="ot">TRUE</span>)
<span class="kw">dim</span>(A)</code></pre></div>
<pre><code>## [1] 2 3</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">B &lt;-<span class="st"> </span><span class="kw">matrix</span>(<span class="dv">1</span>:<span class="dv">6</span>, <span class="dt">nrow=</span><span class="dv">3</span>, <span class="dt">ncol=</span><span class="dv">2</span>, <span class="dt">byrow=</span><span class="ot">TRUE</span>)
<span class="kw">dim</span>(B)</code></pre></div>
<pre><code>## [1] 3 2</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">A %*%<span class="st"> </span>B</code></pre></div>
<pre><code>##      [,1] [,2]
## [1,]   22   28
## [2,]   49   64</code></pre>
<p>Also convenient would be <code>crossprod</code> and <code>tcrossprod</code> functions. <code>crossprod(A, b) = t(A) %*% B</code> and <code>tcrossprod(A, B) = A %*% t(B)</code>.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">crossprod</span>(<span class="kw">t</span>(A), B)</code></pre></div>
<pre><code>##      [,1] [,2]
## [1,]   22   28
## [2,]   49   64</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">tcrossprod</span>(A, <span class="kw">t</span>(B))</code></pre></div>
<pre><code>##      [,1] [,2]
## [1,]   22   28
## [2,]   49   64</code></pre>
<p>Size mismatch raises an error.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">A &lt;-<span class="st"> </span><span class="kw">matrix</span>(<span class="dv">1</span>:<span class="dv">6</span>, <span class="dt">nrow=</span><span class="dv">2</span>, <span class="dt">ncol=</span><span class="dv">3</span>, <span class="dt">byrow=</span><span class="ot">TRUE</span>)
<span class="kw">dim</span>(A)</code></pre></div>
<pre><code>## [1] 2 3</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">C &lt;-<span class="st"> </span><span class="kw">matrix</span>(<span class="dv">1</span>:<span class="dv">4</span>, <span class="dt">nrow=</span><span class="dv">2</span>, <span class="dt">ncol=</span><span class="dv">2</span>, <span class="dt">byrow=</span><span class="ot">TRUE</span>)
<span class="kw">dim</span>(C)</code></pre></div>
<pre><code>## [1] 2 2</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">A %*%<span class="st"> </span>C</code></pre></div>
<pre><code>## Error in A %*% C: non-conformable arguments</code></pre>
</div>
<div id="dot-products-in-neural-network" class="section level3">
<h3><span class="header-section-number">3.2.2</span> Dot products in neural network</h3>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">X &lt;-<span class="st"> </span><span class="kw">array</span>(<span class="dv">1</span>:<span class="dv">2</span>)
<span class="kw">dim</span>(X)</code></pre></div>
<pre><code>## [1] 2</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">W &lt;-<span class="st"> </span><span class="kw">matrix</span>(<span class="dv">1</span>:<span class="dv">6</span>, <span class="dt">nrow=</span><span class="dv">2</span>, <span class="dt">ncol=</span><span class="dv">3</span>, <span class="dt">byrow=</span><span class="ot">FALSE</span>)
W</code></pre></div>
<pre><code>##      [,1] [,2] [,3]
## [1,]    1    3    5
## [2,]    2    4    6</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">dim</span>(W)</code></pre></div>
<pre><code>## [1] 2 3</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">X %*%<span class="st"> </span>W</code></pre></div>
<pre><code>##      [,1] [,2] [,3]
## [1,]    5   11   17</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># or equivalently</span>
<span class="kw">crossprod</span>(X, W)</code></pre></div>
<pre><code>##      [,1] [,2] [,3]
## [1,]    5   11   17</code></pre>
</div>
<div id="implementing-3-layer-neural-network" class="section level3">
<h3><span class="header-section-number">3.2.3</span> Implementing 3-layer neural network</h3>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">identity_func &lt;-<span class="st"> </span>function(a) { a }

init_network &lt;-<span class="st"> </span>function()
{
  <span class="kw">list</span>(<span class="dt">W1 =</span> <span class="kw">array</span>((<span class="dv">1</span>:<span class="dv">6</span>)/<span class="dv">10</span>, <span class="dt">dim=</span><span class="kw">c</span>(<span class="dv">2</span>,<span class="dv">3</span>)),
       <span class="dt">b1 =</span> (<span class="dv">1</span>:<span class="dv">3</span>)/<span class="dv">10</span>,
       <span class="dt">W2 =</span> <span class="kw">array</span>((<span class="dv">1</span>:<span class="dv">6</span>)/<span class="dv">10</span>, <span class="dt">dim=</span><span class="kw">c</span>(<span class="dv">3</span>,<span class="dv">2</span>)),
       <span class="dt">b2 =</span> <span class="kw">c</span>(<span class="fl">0.1</span>, <span class="fl">0.2</span>),
       <span class="dt">W3 =</span> <span class="kw">array</span>((<span class="dv">1</span>:<span class="dv">4</span>)/<span class="dv">10</span>, <span class="dt">dim=</span><span class="kw">c</span>(<span class="dv">2</span>,<span class="dv">2</span>)),
       <span class="dt">b3 =</span> <span class="kw">c</span>(<span class="fl">0.1</span>, <span class="fl">0.2</span>))
}

forward &lt;-<span class="st"> </span>function(network, x)
{
  if (<span class="kw">is.vector</span>(x)) x &lt;-<span class="st"> </span><span class="kw">array</span>(x, <span class="dt">dim=</span><span class="kw">c</span>(<span class="dv">1</span>, <span class="kw">length</span>(x)))
  a1 &lt;-<span class="st"> </span>x %*%<span class="st"> </span>network$W1 +<span class="st"> </span>network$b1
  z1 &lt;-<span class="st"> </span><span class="kw">sigmoid</span>(a1)
  a2 &lt;-<span class="st"> </span>z1 %*%<span class="st"> </span>network$W2 +<span class="st"> </span>network$b2
  z2 &lt;-<span class="st"> </span><span class="kw">sigmoid</span>(a2)
  a3 &lt;-<span class="st"> </span>z2 %*%<span class="st"> </span>network$W3 +<span class="st"> </span>network$b3
  y &lt;-<span class="st"> </span><span class="kw">identity_func</span>(a3)
  y
}

network &lt;-<span class="st"> </span><span class="kw">init_network</span>()
x &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="dv">1</span>, <span class="fl">0.5</span>)
y &lt;-<span class="st"> </span><span class="kw">forward</span>(network, x)
y</code></pre></div>
<pre><code>##           [,1]      [,2]
## [1,] 0.3168271 0.6962791</code></pre>
</div>
</div>
<div id="output-layer" class="section level2">
<h2><span class="header-section-number">3.3</span> Output layer</h2>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">softmax &lt;-<span class="st"> </span>function(a)
{
  C &lt;-<span class="st"> </span><span class="kw">max</span>(a)
  exp_a &lt;-<span class="st"> </span><span class="kw">exp</span>(a-C)
  exp_a /<span class="st"> </span><span class="kw">sum</span>(exp_a)
}

a &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="fl">0.3</span>, <span class="fl">2.9</span>, <span class="fl">4.0</span>)
y &lt;-<span class="st"> </span><span class="kw">softmax</span>(a)
y</code></pre></div>
<pre><code>## [1] 0.01821127 0.24519181 0.73659691</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">sum</span>(y)</code></pre></div>
<pre><code>## [1] 1</code></pre>
</div>
<div id="mnist" class="section level2">
<h2><span class="header-section-number">3.4</span> MNIST</h2>
<p>Run scripts for defining the mnist data loader and image plot helper functions.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">source</span>(<span class="st">&quot;mnist.R&quot;</span>)
<span class="kw">source</span>(<span class="st">&quot;helpers.R&quot;</span>)</code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">d &lt;-<span class="st"> </span><span class="kw">load_mnist</span>(<span class="dt">normalize=</span><span class="ot">TRUE</span>, <span class="dt">flatten=</span><span class="ot">FALSE</span>, <span class="dt">one_hot_label=</span><span class="ot">FALSE</span>)
<span class="kw">str</span>(d)</code></pre></div>
<pre><code>## List of 4
##  $ train_img  : num [1:60000, 1:28, 1:28] 0 0 0 0 0 0 0 0 0 0 ...
##  $ train_label: int [1:60000] 5 0 4 1 9 2 1 3 1 4 ...
##  $ test_img   : num [1:10000, 1:28, 1:28] 0 0 0 0 0 0 0 0 0 0 ...
##  $ test_label : int [1:10000] 7 2 1 0 4 1 4 9 5 9 ...</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">random_plot</span>(d$train_img, d$train_label)</code></pre></div>
<p><img src="_main_files/figure-html/unnamed-chunk-37-1.png" width="672" /></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">random_plot</span>(d$test_img, d$test_label)</code></pre></div>
<p><img src="_main_files/figure-html/unnamed-chunk-37-2.png" width="672" /></p>
<div id="convert-pickled-sample-weights-to-r-data" class="section level3">
<h3><span class="header-section-number">3.4.1</span> Convert pickled sample weights to R data</h3>
<p>The original book provides pre-trained network weights in the GitHub repository <a href="https://raw.githubusercontent.com/oreilly-japan/deep-learning-from-scratch/master/ch03/sample_weight.pkl">sample_weight.pkl</a>. The file needs to be converted R data format to be used in R.</p>
<p>To do so, first, use <code>savetxt</code> method of <code>numpy</code> to save weights in text files. The python script below creates six text files: <code>b1</code>, <code>b2</code>, <code>b3</code>, <code>W1</code>, <code>W2</code> and <code>W3</code>.</p>
<div class="sourceCode"><pre class="sourceCode python"><code class="sourceCode python"><span class="im">import</span> numpy <span class="im">as</span> np
<span class="im">import</span> pickle
<span class="cf">with</span> <span class="bu">open</span>(<span class="st">&quot;sample_weight.pkl&quot;</span>, <span class="st">&quot;rb&quot;</span>) <span class="im">as</span> f:
    data <span class="op">=</span> pickle.load(f)
<span class="cf">for</span> key <span class="op">in</span> data:
    np.savetxt(key, data[key])</code></pre></div>
<p>Then run the following command in R to make them into a R data file.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">b1 &lt;-<span class="st"> </span><span class="kw">scan</span>(<span class="st">&quot;sample-weight/b1&quot;</span>)
b2 &lt;-<span class="st"> </span><span class="kw">scan</span>(<span class="st">&quot;sample-weight/b2&quot;</span>)
b3 &lt;-<span class="st"> </span><span class="kw">scan</span>(<span class="st">&quot;sample-weight/b3&quot;</span>)

W1 &lt;-<span class="st"> </span><span class="kw">read.table</span>(<span class="st">&quot;sample-weight/W1&quot;</span>, <span class="dt">header=</span><span class="ot">FALSE</span>, <span class="dt">sep=</span><span class="st">&quot; &quot;</span>)
W2 &lt;-<span class="st"> </span><span class="kw">read.table</span>(<span class="st">&quot;sample-weight/W2&quot;</span>, <span class="dt">header=</span><span class="ot">FALSE</span>, <span class="dt">sep=</span><span class="st">&quot; &quot;</span>)
W3 &lt;-<span class="st"> </span><span class="kw">read.table</span>(<span class="st">&quot;sample-weight/W3&quot;</span>, <span class="dt">header=</span><span class="ot">FALSE</span>, <span class="dt">sep=</span><span class="st">&quot; &quot;</span>)
W1 &lt;-<span class="st"> </span><span class="kw">as.matrix</span>(W1)
W2 &lt;-<span class="st"> </span><span class="kw">as.matrix</span>(W2)
W3 &lt;-<span class="st"> </span><span class="kw">as.matrix</span>(W3)
<span class="kw">dimnames</span>(W1) &lt;-<span class="st"> </span><span class="ot">NULL</span>
<span class="kw">dimnames</span>(W2) &lt;-<span class="st"> </span><span class="ot">NULL</span>
<span class="kw">dimnames</span>(W3) &lt;-<span class="st"> </span><span class="ot">NULL</span>


out &lt;-<span class="st"> </span><span class="kw">list</span>(<span class="dt">b1=</span>b1, <span class="dt">b2=</span>b2, <span class="dt">b3=</span>b3, <span class="dt">W1=</span>W1, <span class="dt">W2=</span>W2, <span class="dt">W3=</span>W3)
<span class="kw">saveRDS</span>(out, <span class="st">&quot;sample_weight.rds&quot;</span>)</code></pre></div>
</div>
<div id="prediction-with-sample-network-weights" class="section level3">
<h3><span class="header-section-number">3.4.2</span> Prediction with sample network weights</h3>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">get_data &lt;-<span class="st"> </span>function() 
{
  <span class="co"># load and return test data</span>
  d &lt;-<span class="st"> </span><span class="kw">load_mnist</span>(<span class="dt">normalize=</span><span class="ot">TRUE</span>, <span class="dt">flatten=</span><span class="ot">TRUE</span>, <span class="dt">one_hot_label=</span><span class="ot">FALSE</span>)
  d[<span class="kw">c</span>(<span class="st">&quot;test_img&quot;</span>, <span class="st">&quot;test_label&quot;</span>)]
}

init_network &lt;-<span class="st"> </span>function()
{
  <span class="co"># load and return network weights</span>
  network &lt;-<span class="st"> </span><span class="kw">readRDS</span>(<span class="st">&quot;sample_weight.rds&quot;</span>)
  network
}

prediction &lt;-<span class="st"> </span>function(network, x)
{
  if (<span class="kw">is.vector</span>(x)) x &lt;-<span class="st"> </span><span class="kw">array</span>(x, <span class="dt">dim=</span><span class="kw">c</span>(<span class="dv">1</span>, <span class="kw">length</span>(x)))
  a1 &lt;-<span class="st"> </span>x %*%<span class="st"> </span>network$W1 +<span class="st"> </span>network$b1
  z1 &lt;-<span class="st"> </span><span class="kw">sigmoid</span>(a1)
  a2 &lt;-<span class="st"> </span>z1 %*%<span class="st"> </span>network$W2 +<span class="st"> </span>network$b2
  z2 &lt;-<span class="st"> </span><span class="kw">sigmoid</span>(a2)
  a3 &lt;-<span class="st"> </span>z2 %*%<span class="st"> </span>network$W3 +<span class="st"> </span>network$b3
  y &lt;-<span class="st"> </span><span class="kw">softmax</span>(a3)
  y
}

d &lt;-<span class="st"> </span><span class="kw">get_data</span>()
network &lt;-<span class="st"> </span><span class="kw">init_network</span>()
<span class="kw">str</span>(d)</code></pre></div>
<pre><code>## List of 2
##  $ test_img  : num [1:10000, 1:784] 0 0 0 0 0 0 0 0 0 0 ...
##  $ test_label: int [1:10000] 7 2 1 0 4 1 4 9 5 9 ...</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">str</span>(network)</code></pre></div>
<pre><code>## List of 6
##  $ b1: num [1:50] -0.0675 0.0696 -0.0273 0.0226 -0.22 ...
##  $ b2: num [1:100] -0.01471 -0.07215 -0.00156 0.122 0.11603 ...
##  $ b3: num [1:10] -0.06024 0.00933 -0.0136 0.02167 0.01074 ...
##  $ W1: num [1:784, 1:50] -0.00741 -0.0103 -0.01309 -0.01001 0.02207 ...
##  $ W2: num [1:50, 1:100] -0.1069 0.2991 0.0658 0.0939 0.048 ...
##  $ W3: num [1:100, 1:10] -0.422 -0.524 0.683 0.155 0.505 ...</code></pre>
<p>One-by-one prediction.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">accuracy_count &lt;-<span class="st"> </span><span class="dv">0</span>
for (i in <span class="dv">1</span>:<span class="kw">length</span>(d$test_label))
{
  y &lt;-<span class="st"> </span><span class="kw">prediction</span>(network, d$test_img[i,])
  p &lt;-<span class="st"> </span><span class="kw">which.max</span>(y)-1L
  if (p ==<span class="st"> </span>d$test_label[i]) accuracy_count &lt;-<span class="st"> </span>accuracy_count +<span class="st"> </span><span class="dv">1</span>
}
<span class="kw">cat</span>(<span class="st">&quot;Accuracy:&quot;</span>, accuracy_count/<span class="kw">length</span>(d$test_label), <span class="st">&quot;</span><span class="ch">\n</span><span class="st">&quot;</span>)</code></pre></div>
<pre><code>## Accuracy: 0.9352</code></pre>
<p>For batch prediction, we need to modify the softmax function to work for matrix input.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">softmax &lt;-<span class="st"> </span>function(a)
{
  <span class="co"># a : either numeric vector or matrix of size (N, classes)</span>
  <span class="co"># </span>
  <span class="co"># returns: probability matrix of size (N, classes)</span>
  
  if (<span class="kw">is.vector</span>(a)) <span class="kw">dim</span>(a) &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="dv">1</span>, <span class="kw">length</span>(a))
  
  C &lt;-<span class="st"> </span><span class="kw">max</span>(a)
  exp_a &lt;-<span class="st"> </span><span class="kw">exp</span>(a-C)
  exp_a /<span class="st"> </span><span class="kw">rowSums</span>(exp_a)
}
a &lt;-<span class="st"> </span><span class="kw">matrix</span>(<span class="kw">c</span>(<span class="dv">3</span>, <span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">5</span>), <span class="dt">nrow=</span><span class="dv">2</span>, <span class="dt">ncol=</span><span class="dv">3</span>, <span class="dt">byrow=</span><span class="ot">TRUE</span>)
<span class="kw">softmax</span>(a)</code></pre></div>
<pre><code>##            [,1]       [,2]      [,3]
## [1,] 0.66524096 0.09003057 0.2447285
## [2,] 0.01714783 0.04661262 0.9362396</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">rowSums</span>(<span class="kw">softmax</span>(a))</code></pre></div>
<pre><code>## [1] 1 1</code></pre>
<p>Also, prediction function needs to be revised due to the broadcasting rule of R.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">prediction &lt;-<span class="st"> </span>function(network, x)
{
  if (<span class="kw">is.vector</span>(x)) x &lt;-<span class="st"> </span><span class="kw">array</span>(x, <span class="dt">dim=</span><span class="kw">c</span>(<span class="dv">1</span>, <span class="kw">length</span>(x)))
  x &lt;-<span class="st"> </span><span class="kw">t</span>(x)
  a1 &lt;-<span class="st"> </span><span class="kw">crossprod</span>(network$W1, x) +<span class="st"> </span>network$b1
  z1 &lt;-<span class="st"> </span><span class="kw">sigmoid</span>(a1)
  a2 &lt;-<span class="st"> </span><span class="kw">crossprod</span>(network$W2, z1) +<span class="st"> </span>network$b2
  z2 &lt;-<span class="st"> </span><span class="kw">sigmoid</span>(a2)
  a3 &lt;-<span class="st"> </span><span class="kw">crossprod</span>(network$W3, z2) +<span class="st"> </span>network$b3
  a3 &lt;-<span class="st"> </span><span class="kw">t</span>(a3)
  y &lt;-<span class="st"> </span><span class="kw">softmax</span>(a3)
  y
}</code></pre></div>
<p>Batch prediction.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">batch_size &lt;-<span class="st"> </span><span class="dv">100</span>
accuracy_count &lt;-<span class="st"> </span><span class="dv">0</span>
for (i in <span class="kw">seq</span>(<span class="dv">1</span>, <span class="kw">length</span>(d$test_label), batch_size))
{
  index &lt;-<span class="st"> </span>i:<span class="kw">min</span>((i+batch_size<span class="dv">-1</span>), <span class="kw">length</span>(d$test_label)) 
  y &lt;-<span class="st"> </span><span class="kw">prediction</span>(network, d$test_img[index,])
  p &lt;-<span class="st"> </span><span class="kw">apply</span>(y, <span class="dv">1</span>, which.max) -<span class="st"> </span>1L  <span class="co"># one-base index</span>
  accuracy_count &lt;-<span class="st"> </span>accuracy_count +<span class="st"> </span><span class="kw">sum</span>(p==d$test_label[index])
}
<span class="kw">cat</span>(<span class="st">&quot;Accuracy:&quot;</span>, accuracy_count/<span class="kw">length</span>(d$test_label), <span class="st">&quot;</span><span class="ch">\n</span><span class="st">&quot;</span>)</code></pre></div>
<pre><code>## Accuracy: 0.9352</code></pre>

</div>
</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="perceptron.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="training-neural-network.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script>
require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"google": false,
"weibo": false,
"instapper": false,
"vk": false,
"all": ["facebook", "google", "twitter", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": null,
"text": null
},
"download": null,
"toc": {
"collapse": "subsection"
}
});
});
</script>

</body>

</html>
